<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absen Digital Kelas 5 - SDN 1 PASIRPOGOR</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Nunito:wght@400;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --blue-primary: #1e40af;
            --blue-secondary: #3b82f6;
            --blue-light: #dbeafe;
            --green-primary: #047857;
            --green-secondary: #059669;
            --green-light: #d1fae5;
            --white: #ffffff;
            --light-gray: #f8fafc;
            --text-dark: #1e293b;
            --text-gray: #64748b;
            --shadow: rgba(15, 23, 42, 0.08);
            --shadow-medium: rgba(15, 23, 42, 0.12);
            --shadow-strong: rgba(15, 23, 42, 0.16);
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --gradient-bg: linear-gradient(135deg, #1e40af 0%, #047857 100%);
            --gradient-header: linear-gradient(135deg, #1e40af 0%, #0369a1 50%, #047857 100%);
            --gradient-button: linear-gradient(135deg, #1e40af 0%, #047857 100%);
            --gradient-card: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 25%, #0c4a6e 50%, #0f766e 75%, #065f46 100%);
            color: var(--text-dark);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .app-container {
            width: 100%;
            max-width: 1200px;
            background-color: var(--white);
            border-radius: 24px;
            box-shadow: 0 25px 50px var(--shadow-strong);
            overflow: hidden;
            position: relative;
            min-height: 85vh;
            animation: fadeIn 0.8s ease-out;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            background: var(--gradient-header);
            padding: 25px;
            text-align: center;
            position: relative;
            box-shadow: 0 8px 25px var(--shadow-medium);
        }

        .logo {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, var(--green-primary), var(--green-secondary));
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 40px;
            color: var(--white);
            box-shadow: 0 8px 32px rgba(4, 120, 87, 0.3);
            animation: pulse 3s infinite;
            border: 4px solid rgba(255, 255, 255, 0.2);
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 8px 32px rgba(4, 120, 87, 0.3);
            }

            50% {
                transform: scale(1.05);
                box-shadow: 0 12px 40px rgba(4, 120, 87, 0.4);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 8px 32px rgba(4, 120, 87, 0.3);
            }
        }

        .school-name {
            font-size: 28px;
            font-weight: 800;
            color: var(--white);
            margin-bottom: 8px;
            letter-spacing: 0.5px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .subtitle {
            font-size: 18px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
            text-shadow: 0 1px 5px rgba(0, 0, 0, 0.1);
        }

        .slide-container {
            display: none;
            padding: 25px;
            min-height: 65vh;
        }

        .slide-container.active {
            display: block;
            animation: slideIn 0.6s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-form {
            max-width: 420px;
            margin: 40px auto;
            padding: 40px;
            background: var(--gradient-card);
            border-radius: 20px;
            box-shadow: 0 20px 40px var(--shadow-medium);
            animation: scaleIn 0.7s ease-out;
            border: 1px solid rgba(30, 64, 175, 0.1);
        }

        @keyframes scaleIn {
            from {
                transform: scale(0.95);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .form-group {
            margin-bottom: 24px;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--text-dark);
            font-size: 15px;
        }

        .form-group input {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid var(--blue-light);
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background-color: var(--white);
            color: var(--text-dark);
        }

        .form-group input:focus {
            border-color: var(--blue-primary);
            outline: none;
            box-shadow: 0 0 0 4px rgba(30, 64, 175, 0.1);
            transform: translateY(-1px);
        }

        .password-container {
            position: relative;
        }

        .toggle-password {
            position: absolute;
            right: 18px;
            top: 48px;
            cursor: pointer;
            color: var(--text-gray);
            transition: all 0.3s ease;
        }

        .toggle-password:hover {
            color: var(--blue-primary);
            transform: scale(1.1);
        }

        .login-button {
            width: 100%;
            padding: 16px;
            background: var(--gradient-button);
            color: var(--white);
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            box-shadow: 0 8px 20px rgba(30, 64, 175, 0.3);
        }

        .login-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(30, 64, 175, 0.4);
        }

        .error-message {
            color: var(--error);
            text-align: center;
            margin-top: 16px;
            font-weight: 600;
            display: none;
            animation: shake 0.5s;
            background-color: rgba(239, 68, 68, 0.1);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            20%,
            60% {
                transform: translateX(-8px);
            }

            40%,
            80% {
                transform: translateX(8px);
            }
        }

        .footer {
            text-align: center;
            margin-top: 35px;
            color: var(--text-gray);
            font-size: 14px;
        }

        .date-display {
            text-align: center;
            margin: 25px 0;
            font-size: 18px;
            font-weight: 600;
            color: var(--text-dark);
            background: var(--gradient-card);
            padding: 20px;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 8px 25px var(--shadow);
            border: 1px solid var(--blue-light);
        }

        .digital-clock {
            font-size: 32px;
            font-weight: 800;
            margin-top: 12px;
            background: var(--gradient-button);
            padding: 12px 24px;
            border-radius: 12px;
            color: var(--white);
            box-shadow: 0 8px 20px rgba(30, 64, 175, 0.3);
            display: inline-block;
            font-family: 'Poppins', sans-serif;
            animation: pulse 2s infinite;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 16px;
            margin-bottom: 35px;
        }

        .action-button {
            padding: 16px 24px;
            border-radius: 14px;
            border: none;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s ease;
            font-family: 'Poppins', sans-serif;
            box-shadow: 0 8px 20px var(--shadow);
            min-width: 200px;
            color: var(--white);
        }

        .action-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px var(--shadow-medium);
        }

        .kelola-siswa {
            background: linear-gradient(135deg, #0369a1, #0284c7);
        }

        .present-all {
            background: linear-gradient(135deg, #059669, #10b981);
        }

        .submit-attendance {
            background: var(--gradient-button);
        }

        .rekap-harian {
            background: linear-gradient(135deg, #3b82f6, #60a5fa);
        }

        .rekap-bulanan {
            background: linear-gradient(135deg, #1e40af, #2563eb);
        }

        .export-excel {
            background: linear-gradient(135deg, #047857, #059669) !important;
            color: white !important;
            position: relative;
            overflow: hidden;
            min-width: 220px;
        }

        .export-excel:hover::after {
            content: "↓";
            position: absolute;
            right: 16px;
            animation: bounce 0.5s infinite alternate;
        }

        @keyframes bounce {
            from {
                transform: translateY(0);
            }

            to {
                transform: translateY(-5px);
            }
        }

        .students-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        @media (min-width: 576px) {
            .students-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (min-width: 768px) {
            .students-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (min-width: 992px) {
            .students-grid {
                grid-template-columns: repeat(5, 1fr);
            }
        }

        @media (min-width: 1200px) {
            .students-grid {
                grid-template-columns: repeat(6, 1fr);
            }
        }

        .student-card {
            background: var(--gradient-card);
            border-radius: 16px;
            padding: 18px;
            text-align: center;
            box-shadow: 0 8px 25px var(--shadow);
            transition: all 0.3s ease;
            animation: popIn 0.5s ease-out;
            border: 1px solid var(--blue-light);
        }

        @keyframes popIn {
            0% {
                transform: scale(0.9);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .student-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 35px var(--shadow-medium);
            border-color: var(--blue-secondary);
        }

        .student-avatar {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: var(--gradient-button);
            margin: 0 auto 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            font-weight: 700;
            color: var(--white);
            box-shadow: 0 6px 20px rgba(30, 64, 175, 0.3);
        }

        .student-name {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            color: var(--text-dark);
        }

        .attendance-status {
            width: 100%;
            padding: 10px;
            border-radius: 10px;
            border: 2px solid var(--blue-light);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: var(--white);
            color: var(--text-dark);
        }

        .attendance-status:focus {
            border-color: var(--blue-primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
        }

        .success-message {
            position: fixed;
            top: 25px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--success);
            color: white;
            padding: 16px 32px;
            border-radius: 12px;
            font-weight: 700;
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
            z-index: 1000;
            display: none;
            animation: slideDown 0.5s ease-out;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        @keyframes slideDown {
            from {
                top: -60px;
                opacity: 0;
            }

            to {
                top: 25px;
                opacity: 1;
            }
        }

        .logout-button {
            position: absolute;
            top: 22px;
            right: 22px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            font-size: 20px;
            color: var(--white);
            cursor: pointer;
            transition: all 0.3s ease;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .logout-button:hover {
            color: rgba(255, 255, 255, 0.9);
            transform: scale(1.1);
            background-color: rgba(239, 68, 68, 0.2);
        }

        .date-picker-container {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            gap: 12px;
            flex-wrap: wrap;
        }

        .date-picker {
            padding: 12px 18px;
            border: 2px solid var(--blue-light);
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            text-align: center;
            min-width: 200px;
            background-color: var(--white);
            color: var(--text-dark);
            transition: all 0.3s ease;
        }

        .date-picker:focus {
            border-color: var(--blue-primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(15, 23, 42, 0.4);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
            animation: fadeIn 0.3s;
        }

        .modal-content {
            background: var(--white);
            padding: 35px 25px;
            border-radius: 20px;
            min-width: 360px;
            max-width: 95vw;
            max-height: 90vh;
            overflow: auto;
            box-shadow: 0 25px 50px var(--shadow-strong);
            position: relative;
            border: 1px solid var(--blue-light);
        }

        .modal-content h2 {
            font-size: 24px;
            font-weight: 800;
            text-align: center;
            margin-bottom: 20px;
            color: var(--text-dark);
            background: var(--gradient-button);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .modal-content .close-modal {
            position: absolute;
            top: 20px;
            right: 24px;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-gray);
            transition: all 0.3s ease;
            background: var(--light-gray);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content .close-modal:hover {
            color: var(--error);
            transform: scale(1.1);
            background: rgba(239, 68, 68, 0.1);
        }

        .rekap-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
            font-size: 14px;
            box-shadow: 0 4px 15px var(--shadow);
            border-radius: 12px;
            overflow: hidden;
        }

        .rekap-table th,
        .rekap-table td {
            border: 1px solid var(--blue-light);
            padding: 10px;
            text-align: center;
        }

        .rekap-table th {
            background: var(--gradient-button);
            color: var(--white);
            position: sticky;
            top: 0;
            font-weight: 700;
        }

        .rekap-controls {
            margin-bottom: 12px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 12px;
            justify-content: center;
        }

        .rekap-controls input,
        .rekap-controls select {
            padding: 8px 12px;
            border-radius: 10px;
            border: 2px solid var(--blue-light);
            font-family: 'Nunito', sans-serif;
            transition: all 0.3s ease;
        }

        .rekap-controls input:focus,
        .rekap-controls select:focus {
            border-color: var(--blue-primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
        }

        .search-container {
            margin: 12px 0;
            display: flex;
            gap: 12px;
        }

        .search-container input {
            flex: 1;
            padding: 10px 14px;
            border-radius: 10px;
            border: 2px solid var(--blue-light);
            font-family: 'Nunito', sans-serif;
            transition: all 0.3s ease;
        }

        .search-container input:focus {
            border-color: var(--blue-primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
        }

        .status-hadir {
            background-color: var(--green-light);
        }

        .status-izin {
            background-color: var(--blue-light);
        }

        .status-sakit {
            background-color: rgba(245, 158, 11, 0.2);
        }

        .status-alfa {
            background-color: rgba(239, 68, 68, 0.2);
        }

        .no-data {
            text-align: center;
            padding: 25px;
            color: var(--text-gray);
            font-weight: 600;
        }

        .loading {
            text-align: center;
            padding: 25px;
            color: var(--text-dark);
        }

        .loading i {
            margin-right: 10px;
            color: var(--blue-primary);
        }

        .info-tanggal {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
            text-align: center;
            background: var(--gradient-card);
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 8px 20px var(--shadow);
            border: 1px solid var(--blue-light);
            color: var(--text-dark);
        }

        .app-title {
            text-align: center;
            margin: 12px 0 25px;
            font-size: 24px;
            font-weight: 700;
            color: var(--text-dark);
            position: relative;
        }

        .app-title:after {
            content: '';
            display: block;
            width: 80px;
            height: 4px;
            background: var(--gradient-button);
            margin: 10px auto 0;
            border-radius: 2px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .status-hadir-indicator {
            background-color: var(--success);
        }

        .status-izin-indicator {
            background-color: var(--blue-secondary);
        }

        .status-sakit-indicator {
            background-color: var(--warning);
        }

        .status-alfa-indicator {
            background-color: var(--error);
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: var(--light-gray);
            border-radius: 10px;
            margin-top: 6px;
            overflow: hidden;
            border: 1px solid var(--blue-light);
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-button);
            border-radius: 10px;
            transition: width 0.5s ease;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Login Page -->
        <div id="login-page" class="slide-container active">
            <div class="header">
                <div class="logo"><i class="fas fa-school"></i></div>
                <h1 class="school-name">SDN 1 PASIRPOGOR</h1>
                <p class="subtitle">DAFTAR HADIR SISWA KELAS 5</p>
            </div>
            <form class="login-form" id="loginForm" autocomplete="off">
                <div class="app-title">Login Guru</div>
                <div class="form-group">
                    <label for="username"><i class="fas fa-user"></i> Username</label>
                    <input type="text" id="username" required autocomplete="off">
                </div>
                <div class="form-group password-container">
                    <label for="password"><i class="fas fa-key"></i> Password</label>
                    <input type="password" id="password" required autocomplete="off">
                    <i class="fas fa-eye-slash toggle-password" id="togglePasswordBtn" tabindex="0"
                        aria-label="Tampilkan/sembunyikan password"></i>
                </div>
                <button type="submit" class="login-button">
                    <i class="fas fa-lock"></i> Login
                </button>
                <div id="error-message" class="error-message">
                    Username atau Password salah!
                </div>
            </form>
            <div class="footer">© 2025 SDN 1 PASIRPOGOR - Sistem Absensi Digital</div>
        </div>

        <!-- Home Page -->
        <div id="home-page" class="slide-container">
            <div class="header">
                <button class="logout-button" id="logoutBtn" title="Logout">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
                <div class="logo"><i class="fas fa-school"></i></div>
                <h1 class="school-name">SDN 1 PASIRPOGOR</h1>
                <p class="subtitle">DAFTAR HADIR SISWA KELAS 5</p>
            </div>

            <div class="date-picker-container">
                <input type="date" id="attendance-date" class="date-picker">
                <button id="btnLoadAttendance" class="action-button submit-attendance">
                    <i class="fas fa-calendar-day"></i> Muat Kehadiran
                </button>
            </div>

            <div class="info-tanggal">
                <i class="fas fa-info-circle"></i> Input Data Kehadiran untuk:
                <span id="selected-date-display"></span>
            </div>

            <div class="date-display">
                <i class="fas fa-calendar-alt"></i> <span id="current-date"></span>
                <div class="digital-clock" id="digital-clock">00:00:00</div>
            </div>

            <div class="action-buttons">
                <button class="action-button kelola-siswa" id="btnKelolaSiswa">
                    <i class="fas fa-users-gear"></i> Kelola Siswa
                </button>
                <button class="action-button present-all" id="btnHadirSemua">
                    <i class="fas fa-user-check"></i> Hadir Semua
                </button>
                <button class="action-button submit-attendance" id="btnKirimAbsen">
                    <i class="fas fa-paper-plane"></i> Kirim Absen
                </button>
                <button class="action-button rekap-harian" id="btnRekapHarian">
                    <i class="fas fa-calendar-day"></i> Rekap Harian
                </button>
                <button class="action-button rekap-bulanan" id="btnRekapBulanan">
                    <i class="fas fa-calendar"></i> Rekap Bulanan
                </button>
            </div>

            <div class="students-grid" id="students-container"></div>
        </div>

        <div id="success-message" class="success-message">
            Data telah terkirim!
        </div>

        <!-- Modal Rekap -->
        <div class="modal" id="rekapModal">
            <div class="modal-content" id="rekapModalContent">
                <span class="close-modal" id="closeRekapModal">&times;</span>
            </div>
        </div>
    </div>

    <script>
        // ================= KONFIGURASI SHEETDB =================
        const SHEETDB_URL = "https://sheetdb.io/api/v1/30bqetawgd29k";
        const SHEETDB_URL_REKAP_BULANAN = `${SHEETDB_URL}/sheets/RekapBulanan`;

        // ================= DAFTAR SISWA KELAS 5 =================
        const defaultStudents = [
            "AIRA ALFANISA",
            "ALVARO ABU RIZIQ",
            "AZAHRA MIKAILA PUTRI",
            "DAFFA SYADID AL GHIFARI",
            "DAVITA SHEILA NURASYIFA",
            "DIMAS SAID HAIDIR",
            "DZAKIRA ASSYABIYA RAFIFA",
            "HAYISAM NUGRAHA",
            "HILMA SYAKILA RAHMADANI",
            "KIRANA PUTRI SOFYAN",
            "MEZZA RIZKI MUNANDAR",
            "MUHAMAD IQBAL RACHMADENI",
            "MUHAMAD JUNA",
            "MUHAMAD RIZQI KURNIAWAN",
            "MUHAMAD SYAHDAN",
            "MUHAMAD WILDAN RAMDANI",
            "MUHAMMAD AFANDI RAHMAN",
            "MUHAMMAD SAHDAN ALMUHAIMIN",
            "NADILA AINA ZAHRA",
            "NAUFAL FADIL PRATAMA",
            "NAYLA PUTRI LUTHPIANA",
            "RAHAP",
            "SAHLA YUSHIRA ALMAHA",
            "SALWA TUNNISA HANIFAH",
            "SRI WAHYUNI",
            "UPAIRA NUR APIPAH"
        ];

        const statusOptions = [
            { text: "✔️ Hadir", value: "Hadir", indicator: "status-hadir-indicator" },
            { text: "📄 Izin", value: "Izin", indicator: "status-izin-indicator" },
            { text: "🤒 Sakit", value: "Sakit", indicator: "status-sakit-indicator" },
            { text: "❌ Alfa", value: "Alfa", indicator: "status-alfa-indicator" }
        ];

        let attendanceData = {};
        let students = [...defaultStudents];
        let selectedDate = new Date();
        let searchTimeout;

        // ================= FUNGSI UTAMA =================
        document.addEventListener('DOMContentLoaded', function () {
            // Inisialisasi aplikasi
            initApp();

            // Event listeners
            setupEventListeners();
        });

        function initApp() {
            updateDateTime();
            setInterval(updateDateTime, 1000);

            // Set tanggal default ke hari ini
            const today = new Date();
            const formattedToday = formatDateInput(today);
            document.getElementById('attendance-date').value = formattedToday;
            updateSelectedDateDisplay(today);
            loadAttendanceForDate(today);
        }

        function setupEventListeners() {
            // Login Form
            const loginForm = document.getElementById('loginForm');
            const errorMsg = document.getElementById('error-message');

            loginForm.addEventListener('submit', function (e) {
                e.preventDefault();
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value.trim();

                if (username === 'lita' && password === 'kelas5') {
                    showSlide('home-page');
                    errorMsg.style.display = 'none';
                } else {
                    errorMsg.style.display = 'block';
                    document.getElementById('password').value = '';
                }
            });

            document.getElementById('username').addEventListener('input', () => errorMsg.style.display = 'none');
            document.getElementById('password').addEventListener('input', () => errorMsg.style.display = 'none');
            document.getElementById('togglePasswordBtn').addEventListener('click', togglePassword);
            document.getElementById('togglePasswordBtn').addEventListener('keypress', function (e) {
                if (e.key === "Enter" || e.key === " ") togglePassword();
            });

            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', function () {
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                showSlide('login-page');
            });

            // Date picker
            document.getElementById('attendance-date').addEventListener('change', function () {
                const date = new Date(this.value);
                selectedDate = date;
                updateSelectedDateDisplay(date);
                loadAttendanceForDate(date);
            });

            // Tombol Muat Kehadiran
            document.getElementById('btnLoadAttendance').addEventListener('click', function () {
                const dateInput = document.getElementById('attendance-date').value;
                if (dateInput) {
                    const date = new Date(dateInput);
                    selectedDate = date;
                    updateSelectedDateDisplay(date);
                    loadAttendanceForDate(date);
                }
            });

            // Tombol Aksi
            document.getElementById('btnHadirSemua').addEventListener('click', markAllPresent);
            document.getElementById('btnKirimAbsen').addEventListener('click', submitAttendance);
            document.getElementById('btnRekapHarian').addEventListener('click', showRekapHarian);
            document.getElementById('btnRekapBulanan').addEventListener('click', showRekapBulanan);
            document.getElementById('btnKelolaSiswa').addEventListener('click', showKelolaSiswaModal);
            document.getElementById('closeRekapModal').addEventListener('click', closeRekapModal);
            document.getElementById('rekapModal').addEventListener('click', function (e) {
                if (e.target === this) closeRekapModal();
            });
        }

        // ================= FUNGSI UTILITAS =================
        function formatDateInput(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDate(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}-${month}-${year}`;
        }

        function updateSelectedDateDisplay(date) {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('selected-date-display').textContent =
                date.toLocaleDateString('id-ID', options);
        }

        function updateDateTime() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('current-date').textContent = now.toLocaleDateString('id-ID', options);

            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            document.getElementById('digital-clock').textContent = `${hours}:${minutes}:${seconds}`;
        }

        function showSlide(slideId) {
            document.querySelectorAll('.slide-container').forEach(slide => {
                slide.classList.remove('active');
            });
            document.getElementById(slideId).classList.add('active');
        }

        function togglePassword() {
            const passwordInput = document.getElementById('password');
            const icon = document.getElementById('togglePasswordBtn');
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                icon.classList.replace('fa-eye-slash', 'fa-eye');
            } else {
                passwordInput.type = 'password';
                icon.classList.replace('fa-eye', 'fa-eye-slash');
            }
        }

        function getInitials(name) {
            const parts = name.split(' ');
            if (parts.length === 1) {
                return parts[0].substring(0, 2).toUpperCase();
            }
            return parts.map(part => part[0]).join('').substring(0, 2).toUpperCase();
        }

        // ================= FUNGSI KELOLA SISWA =================
        function showKelolaSiswaModal() {
            let modalContent = `
                <h2>Kelola Daftar Siswa</h2>
                <div class="rekap-controls">
                    <input type="text" id="newStudentName" placeholder="Nama siswa baru">
                    <button id="btnTambahSiswa" class="action-button submit-attendance" style="padding:7px 15px;">
                        <i class="fas fa-plus"></i> Tambah
                    </button>
                </div>
                <div class="search-container">
                    <input type="text" id="searchStudent" placeholder="Cari siswa...">
                </div>
                <div id="studentsListContainer" style="max-height: 400px; overflow-y: auto; margin-top: 15px;">
                    ${generateStudentsListHTML()}
                </div>
            `;

            showRekapModal(modalContent);

            // Event listeners untuk fungsi kelola siswa
            document.getElementById('btnTambahSiswa').addEventListener('click', tambahSiswaBaru);
            document.getElementById('searchStudent').addEventListener('input', filterStudentsList);

            // Tambahkan event listeners untuk tombol hapus
            document.querySelectorAll('.delete-student').forEach(btn => {
                btn.addEventListener('click', function () {
                    hapusSiswa(parseInt(this.getAttribute('data-index')));
                });
            });
        }

        function generateStudentsListHTML() {
            let html = '<ul style="list-style-type: none; padding: 0;">';
            students.forEach((student, index) => {
                html += `
                    <li style="padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                        <span>${student}</span>
                        <button class="delete-student" data-index="${index}" style="background: ${index % 2 === 0 ? '#EF476F' : '#9D4EDD'}; color: white; border: none; border-radius: 5px; padding: 5px 10px; cursor: pointer; transition: all 0.3s;">
                            <i class="fas fa-trash"></i> Hapus
                        </button>
                    </li>
                `;
            });
            html += '</ul>';
            return html;
        }

        function filterStudentsList() {
            const searchTerm = this.value.toLowerCase();
            const items = document.querySelectorAll('#studentsListContainer li');

            items.forEach(item => {
                const name = item.textContent.toLowerCase();
                item.style.display = name.includes(searchTerm) ? '' : 'none';
            });
        }

        function tambahSiswaBaru() {
            const nameInput = document.getElementById('newStudentName');
            const newName = nameInput.value.trim();

            if (newName && !students.includes(newName)) {
                students.push(newName);
                document.getElementById('studentsListContainer').innerHTML = generateStudentsListHTML();
                nameInput.value = '';

                // Tambahkan event listeners untuk tombol hapus yang baru
                document.querySelectorAll('.delete-student').forEach(btn => {
                    btn.addEventListener('click', function () {
                        hapusSiswa(parseInt(this.getAttribute('data-index')));
                    });
                });

                // Perbarui tampilan kartu siswa
                generateStudentCards();
            }
        }

        function hapusSiswa(index) {
            if (confirm(`Apakah Anda yakin ingin menghapus ${students[index]} dari daftar?`)) {
                students.splice(index, 1);
                document.getElementById('studentsListContainer').innerHTML = generateStudentsListHTML();

                // Tambahkan kembali event listeners
                document.querySelectorAll('.delete-student').forEach(btn => {
                    btn.addEventListener('click', function () {
                        hapusSiswa(parseInt(this.getAttribute('data-index')));
                    });
                });

                // Perbarui tampilan kartu siswa
                generateStudentCards();
            }
        }

        // ================= FUNGSI ABSENSI =================
        async function loadAttendanceForDate(date) {
            const formattedDate = formatDate(date);
            document.getElementById('students-container').innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Memuat data...</div>';

            try {
                const res = await fetch(`${SHEETDB_URL}/search?Tanggal=${encodeURIComponent(formattedDate)}`);
                if (!res.ok) throw new Error('Gagal memuat data');

                const data = await res.json();
                attendanceData = {};

                if (Array.isArray(data) && data.length > 0) {
                    data.forEach(item => {
                        if (item["Nama Siswa"] && item["Status Kehadiran"]) {
                            attendanceData[item["Nama Siswa"]] = item["Status Kehadiran"];
                        }
                    });

                    // Set default 'Alfa' untuk siswa yang tidak ada datanya
                    students.forEach(student => {
                        if (!attendanceData[student]) {
                            attendanceData[student] = 'Alfa';
                        }
                    });
                } else {
                    // Jika tidak ada data, set semua siswa sebagai 'Alfa'
                    students.forEach(student => {
                        attendanceData[student] = 'Alfa';
                    });
                }

                generateStudentCards();
            } catch (e) {
                console.error("Error loading attendance:", e);
                students.forEach(student => {
                    attendanceData[student] = 'Alfa';
                });
                generateStudentCards();
                document.getElementById('students-container').innerHTML = '<div class="no-data" style="color:#e74c3c;">Gagal memuat data absensi! Silakan coba lagi.</div>';
            }
        }

        function generateStudentCards() {
            const container = document.getElementById('students-container');
            container.innerHTML = '';

            students.forEach((student) => {
                if (!attendanceData[student]) {
                    attendanceData[student] = 'Alfa';
                }

                const card = document.createElement('div');
                card.className = 'student-card';

                const select = document.createElement('select');
                select.className = 'attendance-status';

                statusOptions.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.value;
                    option.textContent = opt.text;
                    if (attendanceData[student] === opt.value) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });

                select.addEventListener('change', function () {
                    updateAttendance(student, select.value);
                });

                card.innerHTML = `
                    <div class="student-avatar">${getInitials(student)}</div>
                    <div class="student-name">${student}</div>
                `;

                card.appendChild(select);
                container.appendChild(card);
            });
        }

        function updateAttendance(student, status) {
            attendanceData[student] = status;
        }

        function markAllPresent() {
            const btn = document.getElementById('btnHadirSemua');
            btn.innerHTML = '<i class="fas fa-check"></i> Berhasil!';
            btn.style.backgroundColor = '#06D6A0';

            setTimeout(() => {
                btn.innerHTML = '<i class="fas fa-user-check"></i> Hadir Semua';
                btn.style.backgroundColor = '';
            }, 2000);

            students.forEach(student => {
                attendanceData[student] = 'Hadir';
            });
            generateStudentCards();
        }

        async function submitAttendance() {
            const formattedDate = formatDate(selectedDate);
            const message = document.getElementById('success-message');
            let sukses = 0, gagal = 0;

            try {
                // Tampilkan loading
                const btn = document.getElementById('btnKirimAbsen');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mengirim...';
                btn.disabled = true;

                // Langkah 1: Hapus semua data untuk tanggal ini
                try {
                    const deleteRes = await fetch(`${SHEETDB_URL}/search?Tanggal=${encodeURIComponent(formattedDate)}`);
                    if (!deleteRes.ok) throw new Error('Gagal memuat data untuk dihapus');

                    const dataToDelete = await deleteRes.json();

                    if (Array.isArray(dataToDelete) && dataToDelete.length > 0) {
                        // Hapus satu per satu
                        for (const item of dataToDelete) {
                            if (item.id) {
                                await fetch(`${SHEETDB_URL}/id/${item.id}`, { method: 'DELETE' });
                                await new Promise(resolve => setTimeout(resolve, 200)); // Jeda untuk menghindari rate limit
                            }
                        }
                    }
                } catch (deleteError) {
                    console.error("Error deleting existing data:", deleteError);
                    // Lanjutkan meskipun ada error saat menghapus
                }

                // Langkah 2: Kirim semua data baru
                const dataArr = students.map(nama => ({
                    Tanggal: formattedDate,
                    "Nama Siswa": nama,
                    "Status Kehadiran": attendanceData[nama] || 'Alfa'
                }));

                const res = await fetch(SHEETDB_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ data: dataArr })
                });

                if (res.ok) {
                    const result = await res.json();
                    sukses = result.created || students.length;
                } else {
                    throw new Error('Gagal mengirim data batch');
                }
            } catch (e) {
                console.error("Error saat mengirim data:", e);
                gagal = students.length;
            } finally {
                // Reset tombol
                const btn = document.getElementById('btnKirimAbsen');
                btn.innerHTML = '<i class="fas fa-paper-plane"></i> Kirim Absen';
                btn.disabled = false;
            }

            // Tampilkan pesan hasil
            if (sukses > 0 && gagal === 0) {
                message.textContent = 'Semua absensi berhasil diperbarui!';
                message.style.backgroundColor = '#06D6A0';
            } else if (sukses > 0) {
                message.textContent = `Sebagian absensi berhasil (${sukses}), gagal (${gagal}).`;
                message.style.backgroundColor = '#FFD166';
            } else {
                message.textContent = 'Gagal memperbarui absensi!';
                message.style.backgroundColor = '#EF476F';
            }

            message.style.display = 'block';
            setTimeout(() => {
                message.style.display = 'none';
            }, 3000);

            // Muat ulang data absensi untuk memastikan data terbaru
            await loadAttendanceForDate(selectedDate);
        }

        // ================= FUNGSI REKAP =================
        function showRekapModal(contentHTML) {
            document.getElementById('rekapModalContent').innerHTML =
                '<span class="close-modal" id="closeRekapModal">&times;</span>' + contentHTML;
            document.getElementById('rekapModal').classList.add('active');
            document.getElementById('closeRekapModal').addEventListener('click', closeRekapModal);
        }

        function closeRekapModal() {
            document.getElementById('rekapModal').classList.remove('active');
        }

        // REKAP HARIAN
        function showRekapHarian() {
            let dateInputHTML = `
                <div class="rekap-controls">
                    <label for="rekapTanggal"><b>Pilih Tanggal:</b></label>
                    <input type="date" id="rekapTanggal" value="${formatDateInput(selectedDate)}">
                    <button id="btnCariRekapHarian" class="action-button submit-attendance" style="padding:7px 15px;">
                        <i class="fas fa-search"></i> Tampilkan
                    </button>
                </div>
                <div id="rekapHarianResult"></div>
            `;

            showRekapModal(`<h2>Rekap Harian</h2>${dateInputHTML}`);

            document.getElementById('btnCariRekapHarian').addEventListener('click', function () {
                const tanggal = document.getElementById('rekapTanggal').value;
                if (tanggal) {
                    const dateObj = new Date(tanggal);
                    loadRekapHarian(dateObj);
                }
            });

            loadRekapHarian(selectedDate);
        }

        async function loadRekapHarian(date) {
            const formattedDate = formatDate(date);
            const resultDiv = document.getElementById('rekapHarianResult');

            if (isNaN(date.getTime())) {
                resultDiv.innerHTML = `<div class="no-data">Tanggal tidak valid!</div>`;
                return;
            }

            resultDiv.innerHTML = "<div class='loading'><i class='fas fa-spinner fa-spin'></i> Memuat data...</div>";

            try {
                const res = await fetch(`${SHEETDB_URL}/search?Tanggal=${encodeURIComponent(formattedDate)}`);
                if (!res.ok) throw new Error('Gagal memuat data');

                const data = await res.json();

                if (!Array.isArray(data) || data.length === 0) {
                    resultDiv.innerHTML = `<div class="no-data">Tidak ada data absensi untuk tanggal <b>${formattedDate}</b></div>`;
                    return;
                }

                let searchHTML = `
                    <div class="search-container">
                        <input type="text" id="searchRekapHarian" placeholder="Cari nama siswa...">
                    </div>
                `;

                let tableHTML = `
                    <table class="rekap-table">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Nama Siswa</th>
                                <th>Status Kehadiran</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                let nomor = 1;
                for (let row of data) {
                    const status = row["Status Kehadiran"] || "-";
                    const statusClass = `status-${status.toLowerCase() || ''}`;

                    // Cari indicator yang sesuai
                    const statusOption = statusOptions.find(opt => opt.value === status);
                    const indicatorClass = statusOption ? statusOption.indicator : '';

                    tableHTML += `
                        <tr class="${statusClass}">
                            <td>${nomor++}</td>
                            <td>${row["Nama Siswa"] || "-"}</td>
                            <td>
                                <span class="status-indicator ${indicatorClass}"></span>
                                ${status}
                            </td>
                        </tr>
                    `;
                }

                tableHTML += `</tbody></table>`;
                resultDiv.innerHTML = searchHTML + tableHTML;

                // Fungsi pencarian dengan debounce
                document.getElementById('searchRekapHarian').addEventListener('input', function () {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        const searchTerm = this.value.toLowerCase();
                        const rows = document.querySelectorAll('.rekap-table tbody tr');

                        rows.forEach(row => {
                            const name = row.cells[1].textContent.toLowerCase();
                            row.style.display = name.includes(searchTerm) ? '' : 'none';
                        });
                    }, 300);
                });
            } catch (e) {
                resultDiv.innerHTML = `
                    <div class="no-data" style="color:#e74c3c">
                        Gagal memuat data: ${e.message}
                    </div>
                `;
            }
        }

        // REKAP BULANAN
        function showRekapBulanan() {
            const now = new Date();
            const thisMonth = String(now.getMonth() + 1).padStart(2, '0');
            const thisYear = now.getFullYear();

            const bulanInputHTML = `
                <div class="rekap-controls">
                    <label for="rekapBulan"><b>Pilih Bulan:</b></label>
                    <select id="rekapBulan">
                        ${getBulanOptions(thisMonth)}
                    </select>
                    <label for="rekapTahun"><b>Tahun:</b></label>
                    <input type="number" id="rekapTahun" min="2023" max="${thisYear}" value="${thisYear}" style="width:90px;">
                    <button id="btnCariRekapBulanan" class="action-button rekap-bulanan" style="padding:7px 15px;">
                        <i class="fas fa-search"></i> Tampilkan
                    </button>
                    <button id="btnExportExcel" class="action-button export-excel" style="padding:7px 15px;">
                        <i class="fas fa-file-excel"></i> Export ke Excel
                    </button>
                </div>
                <div id="rekapBulananResult"></div>
            `;

            showRekapModal(`<h2>Rekap Bulanan</h2>${bulanInputHTML}`);

            document.getElementById('btnCariRekapBulanan').addEventListener('click', function () {
                const bulan = document.getElementById('rekapBulan').value;
                const tahun = document.getElementById('rekapTahun').value;
                loadRekapBulanan(bulan, tahun);
            });

            document.getElementById('btnExportExcel').addEventListener('click', exportToExcel);

            loadRekapBulanan(thisMonth, thisYear);
        }

        function getBulanOptions(selected) {
            const bulanArr = [
                "01|Januari", "02|Februari", "03|Maret", "04|April", "05|Mei", "06|Juni",
                "07|Juli", "08|Agustus", "09|September", "10|Oktober", "11|November", "12|Desember"
            ];

            return bulanArr.map(b => {
                const [val, label] = b.split('|');
                return `<option value="${val}" ${val === selected ? 'selected' : ''}>${label}</option>`;
            }).join('');
        }

        async function loadRekapBulanan(bulan, tahun) {
            const resultDiv = document.getElementById('rekapBulananResult');
            resultDiv.innerHTML = "<div class='loading'><i class='fas fa-spinner fa-spin'></i> Memuat data...</div>";

            try {
                const res = await fetch(SHEETDB_URL);
                if (!res.ok) throw new Error('Gagal memuat data');

                const allData = await res.json();

                if (!Array.isArray(allData) || allData.length === 0) {
                    resultDiv.innerHTML = `<div class="no-data">Tidak ada data absensi</div>`;
                    return;
                }

                // Filter data berdasarkan bulan dan tahun
                const filteredData = allData.filter(row => {
                    if (!row.Tanggal) return false;

                    try {
                        const [day, month, year] = row.Tanggal.split('-');
                        return month === bulan && year === tahun;
                    } catch {
                        return false;
                    }
                });

                if (filteredData.length === 0) {
                    resultDiv.innerHTML = `
                        <div class="no-data">
                            Tidak ada data absensi untuk bulan <b>${bulan}-${tahun}</b>
                        </div>
                    `;
                    return;
                }

                // Kelompokkan data per siswa
                const siswaMap = {};
                for (let row of filteredData) {
                    const nama = row["Nama Siswa"];
                    const status = row["Status Kehadiran"];

                    if (!nama) continue;

                    if (!siswaMap[nama]) {
                        siswaMap[nama] = { Hadir: 0, Izin: 0, Sakit: 0, Alfa: 0 };
                    }

                    if (status === "Hadir") siswaMap[nama].Hadir++;
                    else if (status === "Izin") siswaMap[nama].Izin++;
                    else if (status === "Sakit") siswaMap[nama].Sakit++;
                    else siswaMap[nama].Alfa++;
                }

                // Buat tabel rekap
                let searchHTML = `
                    <div class="search-container">
                        <input type="text" id="searchRekapBulanan" placeholder="Cari nama siswa...">
                    </div>
                `;

                let tableHTML = `
                    <table class="rekap-table">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Nama Siswa</th>
                                <th>Hadir</th>
                                <th>Izin</th>
                                <th>Sakit</th>
                                <th>Alfa</th>
                                <th>Total</th>
                                <th>Persentase</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                let nomor = 1;
                // Urutkan berdasarkan nama
                const sortedNames = Object.keys(siswaMap).sort();

                // Simpan data untuk ekspor Excel
                window.rekapDataForExport = [];

                for (let nama of sortedNames) {
                    const stat = siswaMap[nama];
                    const total = stat.Hadir + stat.Izin + stat.Sakit + stat.Alfa;
                    const persentase = total > 0 ? ((stat.Hadir / total) * 100).toFixed(2) : 0;

                    tableHTML += `
                        <tr>
                            <td>${nomor}</td>
                            <td>${nama}</td>
                            <td>${stat.Hadir}</td>
                            <td>${stat.Izin}</td>
                            <td>${stat.Sakit}</td>
                            <td>${stat.Alfa}</td>
                            <td><strong>${total}</strong></td>
                            <td>
                                ${persentase}%
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${persentase}%"></div>
                                </div>
                            </td>
                        </tr>
                    `;

                    // Simpan untuk ekspor
                    window.rekapDataForExport.push({
                        "No": nomor,
                        "Nama Siswa": nama,
                        "Hadir": stat.Hadir,
                        "Izin": stat.Izin,
                        "Sakit": stat.Sakit,
                        "Alfa": stat.Alfa,
                        "Total": total,
                        "Persentase": persentase + "%"
                    });

                    nomor++;
                }

                tableHTML += `</tbody></table>`;

                resultDiv.innerHTML = searchHTML + tableHTML;

                // Fungsi pencarian dengan debounce
                document.getElementById('searchRekapBulanan').addEventListener('input', function () {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        const searchTerm = this.value.toLowerCase();
                        const rows = document.querySelectorAll('.rekap-table tbody tr');

                        rows.forEach(row => {
                            const name = row.cells[1].textContent.toLowerCase();
                            row.style.display = name.includes(searchTerm) ? '' : 'none';
                        });
                    }, 300);
                });
            } catch (e) {
                resultDiv.innerHTML = `
                    <div class="no-data" style="color:#e74c3c">
                        Gagal memuat data: ${e.message}
                    </div>
                `;
            }
        }

        // Fungsi ekspor ke Excel - PERBAIKAN DISINI
        async function exportToExcel() {
            if (!window.rekapDataForExport || window.rekapDataForExport.length === 0) {
                alert('Tidak ada data untuk diekspor!');
                return;
            }

            const bulan = document.getElementById('rekapBulan').value;
            const tahun = document.getElementById('rekapTahun').value;
            const bulanNames = {
                '01': 'Januari', '02': 'Februari', '03': 'Maret', '04': 'April',
                '05': 'Mei', '06': 'Juni', '07': 'Juli', '08': 'Agustus',
                '09': 'September', '10': 'Oktober', '11': 'November', '12': 'Desember'
            };
            const bulanTahun = `${bulanNames[bulan]} ${tahun}`;

            // Ambil data detail untuk sheet kedua
            try {
                const res = await fetch(SHEETDB_URL);
                const allData = await res.json();

                // Filter data berdasarkan bulan dan tahun
                const filteredData = allData.filter(row => {
                    if (!row.Tanggal) return false;
                    try {
                        const [day, month, year] = row.Tanggal.split('-');
                        return month === bulan && year === tahun;
                    } catch {
                        return false;
                    }
                });

                // Buat workbook Excel
                const wb = XLSX.utils.book_new();

                // =================== SHEET 1: REKAP JUMLAH ===================
                const ws1 = XLSX.utils.json_to_sheet([]);

                XLSX.utils.sheet_add_aoa(ws1, [
                    ["SD NEGERI 1 PASIRPOGOR"],
                    ["REKAP BULANAN DAFTAR HADIR SISWA KELAS 5"],
                    [`BULAN : ${bulanTahun}`],
                    [], // Baris kosong
                    [], // Baris kosong
                    ["No", "Nama Siswa", "Hadir", "Izin", "Sakit", "Alfa", "Total", "Persentase"]
                ], { origin: "A1" });

                // Tambahkan data rekap
                XLSX.utils.sheet_add_json(ws1, window.rekapDataForExport, { origin: "A7", skipHeader: true });

                // Tambahkan tanda tangan untuk sheet 1
                const startRow1 = 7 + window.rekapDataForExport.length + 2;
                XLSX.utils.sheet_add_aoa(ws1, [
                    [""], [""], // 2 Baris kosong
                    ["", "", "", "", "", "", "Mengetahui"],
                    ["", "", "", "", "", "", "Walikelas 5"],
                    [""], [""], [""], [""], // 4 Baris kosong
                    ["", "", "", "", "", "", "Lita Purnama, S.Pd"]
                ], { origin: `A${startRow1}` });

                // Set lebar kolom sheet 1
                ws1['!cols'] = [
                    { wch: 5 }, { wch: 30 }, { wch: 8 }, { wch: 8 },
                    { wch: 8 }, { wch: 8 }, { wch: 8 }, { wch: 12 }
                ];

                // Merge sel untuk judul sheet 1
                ws1['!merges'] = [
                    { s: { r: 0, c: 0 }, e: { r: 0, c: 7 } },
                    { s: { r: 1, c: 0 }, e: { r: 1, c: 7 } },
                    { s: { r: 2, c: 0 }, e: { r: 2, c: 7 } }
                ];

                // =================== SHEET 2: REKAP HARIAN ===================
                const ws2 = XLSX.utils.json_to_sheet([]);

                // Ambil semua tanggal unik dari data yang difilter dan urutkan
                const tanggalSet = new Set();
                filteredData.forEach(row => {
                    if (row.Tanggal) tanggalSet.add(row.Tanggal);
                });
                const tanggalArray = Array.from(tanggalSet).sort((a, b) => {
                    const [dayA, monthA, yearA] = a.split('-');
                    const [dayB, monthB, yearB] = b.split('-');
                    const dateA = new Date(yearA, monthA - 1, dayA);
                    const dateB = new Date(yearB, monthB - 1, dayB);
                    return dateA - dateB;
                });

                // Kelompokkan data per siswa untuk sheet 2
                const siswaDataHarian = {};
                filteredData.forEach(row => {
                    const nama = row["Nama Siswa"];
                    const tanggal = row.Tanggal;
                    const status = row["Status Kehadiran"];

                    if (!nama || !tanggal) return;

                    if (!siswaDataHarian[nama]) {
                        siswaDataHarian[nama] = {};
                    }

                    // Konversi status ke singkatan
                    let statusSingkat = 'A'; // Default Alfa
                    if (status === 'Hadir') statusSingkat = 'H';
                    else if (status === 'Izin') statusSingkat = 'I';
                    else if (status === 'Sakit') statusSingkat = 'S';

                    siswaDataHarian[nama][tanggal] = statusSingkat;
                });

                // Buat header untuk sheet 2 - DENGAN KOLOM NO.
                const headerRow = ["No.", "Nama Siswa", ...tanggalArray];

                XLSX.utils.sheet_add_aoa(ws2, [
                    ["SD NEGERI 1 PASIRPOGOR"],
                    ["REKAP BULANAN DAFTAR HADIR SISWA KELAS 5"],
                    [`BULAN : ${bulanTahun}`],
                    [], // Baris kosong
                    [], // Baris kosong
                    headerRow
                ], { origin: "A1" });

                // Tambahkan data siswa untuk sheet 2 - DENGAN NOMOR URUT
                const dataRows = [];
                const sortedSiswa = Object.keys(siswaDataHarian).sort();

                sortedSiswa.forEach((nama, index) => {
                    const row = [index + 1, nama]; // TAMBAH NOMOR URUT
                    tanggalArray.forEach(tanggal => {
                        row.push(siswaDataHarian[nama][tanggal] || '-');
                    });
                    dataRows.push(row);
                });

                XLSX.utils.sheet_add_aoa(ws2, dataRows, { origin: "A7" });

                // Tambahkan tanda tangan untuk sheet 2 - SAMA SEPERTI SHEET 1
                const startRow2 = 7 + dataRows.length + 2;
                const colCount = tanggalArray.length + 2; // +2 karena ada kolom No. dan Nama

                XLSX.utils.sheet_add_aoa(ws2, [
                    [""], [""], // 2 Baris kosong
                    ["", "", "", "", "", "", "Mengetahui"],
                    ["", "", "", "", "", "", "Walikelas 5"],
                    [""], [""], [""], [""], // 4 Baris kosong
                    ["", "", "", "", "", "", "Lita Purnama, S.Pd"]
                ], { origin: `A${startRow2}` });

                // Set lebar kolom untuk sheet 2
                // Set lebar kolom untuk sheet 2 - AUTO WIDTH UNTUK NAMA
                const colWidths2 = [
                    { wch: 5 }  // Kolom No.
                ];

                // Hitung lebar kolom nama siswa berdasarkan nama terpanjang
                let maxNamaLength = 12; // Minimum width
                sortedSiswa.forEach(nama => {
                    if (nama.length > maxNamaLength) {
                        maxNamaLength = nama.length;
                    }
                });
                // Tambah sedikit padding
                colWidths2.push({ wch: maxNamaLength + 2 }); // Kolom Nama Siswa

                // Kolom tanggal tetap 6
                for (let i = 0; i < tanggalArray.length; i++) {
                    colWidths2.push({ wch: 6 }); // Kolom tanggal
                }
                for (let i = 0; i < tanggalArray.length; i++) {
                    colWidths2.push({ wch: 6 }); // Kolom tanggal
                }
                ws2['!cols'] = colWidths2;

                // Merge sel untuk judul sheet 2
                ws2['!merges'] = [
                    { s: { r: 0, c: 0 }, e: { r: 0, c: colCount - 1 } },
                    { s: { r: 1, c: 0 }, e: { r: 1, c: colCount - 1 } },
                    { s: { r: 2, c: 0 }, e: { r: 2, c: colCount - 1 } }
                ];

                // =================== TAMBAHKAN SHEETS KE WORKBOOK ===================
                XLSX.utils.book_append_sheet(wb, ws1, "Rekap Jumlah");
                XLSX.utils.book_append_sheet(wb, ws2, "Rekap Harian");

                // Simpan file
                const fileName = `Rekap_Absensi_${bulanNames[bulan]}_${tahun}.xlsx`;
                XLSX.writeFile(wb, fileName);

            } catch (error) {
                console.error('Error creating Excel:', error);
                alert('Gagal membuat file Excel. Silakan coba lagi.');
            }
        }
    </script>
</body>

</html>